%
%  Simulations
% =============
%

\chapter{Simulations}
\label{Ch:Sim}

The work presented in this thesis has been done using simulations with two particle-in-cell (PIC) codes; OSIRIS \cite{fonseca:2002} and QuickPIC \cite{an:2013, huang:2006}. OSIRIS is a proprietary full PIC code available in 1, 2 and 3 dimensions, with a choice between cartesian and cylindrical coordinates. QuickPIC is a quasi-static 3D PIC code. In this work the open source version of QuickPIC has been used \cite{add:quickpic:web}. For a more detailed description on PIC codes, see Appendix \ref{Apx:PIC}.

Although PIC codes use macro particles, that is, simulated particles represent more than one physical beam or plasma particle, these codes require a lot of CPU power. This is especially true when running in 3D. The preliminary studies presented in Publications \ref{Pub:IPAC15} and \ref{Pub:NAPAC16} were done using OSIRIS with 2D cylindrical coordinates. The main study, Publication \ref{Pub:BL17}, was done using QuickPIC in 3D. In order to perform the detailed parameter scans needed for these studies, the drive beam and accelerating structure had to be scaled down into a more manageable size than the full SPS proton beam. This section will outline the simulation environment chosen for these studies, and the reasons behind these.

% ================================================================================================ %
\section{Evolution of the Proton Beam}
\label{Sim:PBeam}

An initial set of simulations were run to study the evolution of the self-modulation instability in the SPS proton beam. These simulations assumed the plasma was ionised at the centre of the beam, so only the back half of the beam was actually simulated. The beam profile function took the form:
\begin{equation}
    f(\xi,r) = \frac{A}{2} \left[1 + \cos\left(\xi\frac{\pi}{L}\right)\right] \exp\left(-\frac{r^{2}}{2\sigma_{r}^{2}}\right), \label{EQ:SPS-Profile}
\end{equation}
where $L = 2.5\sigma_{z,pb} = 30\unit{cm}$ is the length of half an SPS proton bunch, $R$ is the radius of the simulation box, and $A_{q}$ is a charge scaling factor to match the SPS bunch charge. The charge of the proton beam in cylindrical coordinates is thus given by
\begin{equation}
    Q_{pb} = 2\pi \iint f(\xi,r) \;r \deriv{r}\deriv{\xi}, \label{EQ:SPS-Charge}
\end{equation}
and $A$ is tuned so that $Q_{pb}$ matches the charge outlined in Table \ref{T:AWAKE-Run1}.

% Add figure with FFT of beam.

% ================================================================================================ %

\subsection{Studies with Pre-modulated Beam}
\label{Sim:PBPreMod}

In order to make the simulations more manageable in size, for the beam loading studies we decided to move to a sample proton beam of $26$ micro bunches. The simulations were all done using OSIRIS 3.0. With this version it is necessary for the beams to drift in vacuum for a short distance for the EM-fields to develop properly as they start at zero (see further discussion in Section \ref{PIC:Full}). Since the evolution of the self-modulation instability was not of primary interest in this study, we chose to modify the beam profile to emulate a section of modulated beam. We refer to this as pre-modulation. This was done by shortening the wavelength of the profile in Eq. \ref{EQ:SPS-Profile} to match that of the plasma wavelength:
\begin{equation}
    f(\xi,r) = A\sqrt{2} \left[\frac{1}{2\sqrt{2}} + \cos\left(k_{pe}\xi - \mu\right)\right] \exp\left(-\frac{r^{2}}{2\sigma_{r}^{2}}\right), \label{EQ:PB-PreMod}
\end{equation}
where $\mu$ is the position of the first micro bunch and $k_{pe}$ is the plasma wave number \cite{berglyd_olsen:2015}. The offset of the cosine function is chosen such that the width of the micro bunch matches the width of a bunch in the simulations done with a full beam. Since OSIRIS ignores profile densities with negative values, the profile is automatically clipped at $0$.

Due to the necessary initial drift stage of these simulations, it is technically challenging to inject an electron witness beam while strictly controlling parameters like emittance, energy spread and transverse size as these evolve during this drift phase. There are several ways of preventing the beam from evolving, like slowly ramping up the beam charge or ramping up the beam energy. 

% ================================================================================================ %

\subsection{Studies with Single Drive Bunch}
\label{Sim:PBSingle}

Text

% ================================================================================================ %

\section{Beam Loading and Energy Spread}
\label{Sim:BLoad}

Text

% ================================================================================================ %

\subsection{The Linear Regime}
\label{Sim:Lin}

The ideal case from Tzoufras 2008.

% ================================================================================================ %

\subsection{The Quasi-linear Regime}
\label{Sim:QLin}

Text

% ================================================================================================ %

\section{Emittance Evolution}
\label{Sim:Emitt}

Emittance is preserved in the linear regime

% ================================================================================================ %

\subsection{The Quasi-linear + Non-Linear Case}
\label{Sim:QLinNonLin}

An electron beam matched to the typical AWAKE plasma density will be, as discussed in \ref{Sim:Match}, very narrow. At a typical normalised emittance of $2.0\unit{\mu m}$ the beam is $5.25\unit{\mu m}$. Even at low beam charge and at the upper limit in terms of beam length, the wakefields of such a beam will quickly reach the non-linear regime. In the base case used in the beam loading study included in Publication \ref{Pub:BL17} \cite{berglyd_olsen:2018} the peak density of the beam $n_b/n_0 > 35$, well beyond the saturation level of the bubble that occurs when $n_b/n_0 > 10$ \cite{lu:2005}.

The implication here is that there is an additional benefitial effect of loading the accelerating field with as much charge as it will allow without overloading it. The resulting non-linear wake driven by the head of the beam, which will see emittance growth due to the quasi-linear conditions of the proton wake, ensures that the rest of the beam sees a strong focusing force preventing further emittance growth. As the electron beam gains energy, its transverse size will decrease as its emittance is preserved as $\sigma_{r} = \sqrt{\emitN\beta}$ \cite{wille:2001}.

% ================================================================================================ %

\section{Optimising the Witness Beam}
\label{Sim:Opt}

Bringing it all together.

% ================================================================================================ %
