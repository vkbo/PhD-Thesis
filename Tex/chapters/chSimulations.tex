%
%  Simulations
% =============
%

\chapter{Simulations}
\label{Ch:Sim}

The work presented in this thesis has been performed using simulations with two particle-in-cell (PIC) codes:
OSIRIS \cite{fonseca:2002} and QuickPIC \cite{an:2013, huang:2006}.
OSIRIS is a proprietary full PIC code available in 1, 2 and 3 dimensions, with a choice between Cartesian and cylindrical coordinates.
QuickPIC is a quasi-static 3D PIC code. In this work the open source version of QuickPIC has been used \cite{add:quickpic:web}.
For a more detailed description on PIC codes, see Appendix \ref{Apx:PIC}.

Although PIC codes use macro particles -- that is, simulated particles represent more than one physical beam or plasma particle -- these codes require a lot of CPU power.
This is especially true when running in 3D.
The preliminary studies presented in Publications \ref{Pub:IPAC15} and \ref{Pub:NAPAC16} were done using OSIRIS with 2D cylindrical coordinates.
The main study, Publication \ref{Pub:BL17}, was done using QuickPIC in 3D.
In order to perform the detailed parameter scans needed for these studies, the drive beam and accelerating structure had to be scaled down into a more manageable size than the full SPS proton beam.
This chapter will outline the simulation environment chosen for these studies, and the reasons behind these.

% ================================================================================================================================ %
\section{Evolution of the Proton Beam}
\label{Sim:PBeam}

An initial set of simulations were run to study the evolution of the self-modulation instability in the SPS proton bunch.
These simulations assumed the plasma was ionised at the centre of the bunch, so only the back half of it was actually simulated.
The beam profile function thus took the form:
\begin{equation}
    f(\xi,r) = \frac{A}{2} \left[1 + \cos\left(\xi\frac{\pi}{L}\right)\right] \exp\left(-\frac{r^{2}}{2\sigma_{r}^{2}}\right), \label{EQ:SPS-Profile}
\end{equation}
where $L = 2.5\sigma_{z,pb} = 30\unit{cm}$ is the length of half an SPS proton bunch, $R$ is the radius of the simulation box, and $A_{q}$ is a charge scaling factor to match the SPS bunch charge.
The total charge of the simulated proton bunch in cylindrical coordinates is thus given by:
\begin{equation}
    Q_{pb} = 2\pi \iint f(\xi,r) \;r \deriv r \deriv \xi, \label{EQ:SPS-Charge}
\end{equation}
where $A$ is tuned such that $Q_{pb}$ matches the charge outlined in Table \ref{T:AWAKE-Run1}.
A half period cosine function for the longitudinal density profile is more convenient for simulations than a Gaussian shape, as the cosine goes to zero at a finite length \cite{lotov:2010}.

A total of $38$ simulations of a full AWAKE proton bunch, with and without an injected electron bunch, were run.
As can be seen from Table \ref{T:SimCost}, these simulations took an average of over $11\,000$ CPU hours.

\todo[inline]{Add plot showing full SMI proton beam from S-series simulations. Also add FFT plot.}

% ================================================================================================================================ %

\subsection{Studies with Pre-Modulated Beam}
\label{Sim:PBPreMod}

In order to make the simulations more manageable in size for the beam loading studies, we decided to move to a sample proton beam of $26$ micro bunches.
These simulations were all done using OSIRIS 3.0.
With this version it is necessary for the beams to drift in vacuum for a short distance for the electro-magnetic fields to develop properly, as they are initialised at zero (see further discussion in Section \ref{PIC:Full}).
Since the evolution of the self-modulation instability was not of primary interest at this stage, we chose to modify the beam profile to emulate a section of the modulated bunch.
We refer to this as \textit{pre-modulation}.
This was done by shortening the period of the density envelope cosine function in Eq. \ref{EQ:SPS-Profile} to match that of the plasma wavelength.
\begin{equation}
    f(\xi,r) = A\sqrt{2} \left[\frac{1}{2\sqrt{2}}
             + \cos\left(k_{pe}\xi - \mu\right)\right] \exp\left(-\frac{r^{2}}{2\sigma_{r}^{2}}\right), \label{EQ:PB-PreMod}
\end{equation}
where $\mu$ is the position of the first micro bunch, and $k_{pe}$ is the plasma wave number \cite{berglyd_olsen:2015}.
The offset of the cosine function is chosen such that the width of the micro bunch matches the width of a bunch in the simulations done with a full bunch.
Since OSIRIS ignores profile densities with negative values, the profile is automatically clipped at $0$.

Again, cosines are preferred over a series of Gaussian bunch profiles.
As before, they have clearly defined end points, but also due to limitations in the input files of OSIRIS.
Mathematical functions are limited by the simulation software to $256$ characters.

% Comment about the separation between bunch 1 and 2?

Due to the necessary initial drift stage of these simulations, it is technically challenging to inject an electron witness bunch while strictly controlling parameters like emittance, energy spread and transverse size.
During the drift phase, these parameters undergo evolution.
There are, however, several ways of preventing the beam from evolving in OSIRIS 3.0.
It is possible to slowly ramp up the beam charge or the beam energy.
During these ramping stages, the macro particles are prevented from transverse evolution.
These parameters were tuned such that the bunch was unfrozen a few micrometres before it entered the plasma.

The charge of the proton micro-bunches were matched to that of a micro-bunch generated by the self-modulation instability in the initial simulations.
This charge, of course, decreases towards the back end of the modulated beam, so they were fixed to a charge for the region were the injection of an electron bunch is reasonable.
For the pre-modulated simulations, this number was set to $100\unit{pC}$ such that the total charge of the sample proton beam was $2.6\unit{nC}$.
This corresponds to a peak current of $135\unit{A}$.

The electron bunch was injected between bunch $20$ and $21$.
The transverse size of the beam was chosen to be $\sigma_{x,y}=105\unit{\mu m}$, see Table \ref{T:AWAKE-Run2}.
The longitudinal size was chosen to be $\sigma_{z}=40\unit{\mu m}$ for the studies included in Publication \ref{Pub:IPAC15}, but several lengths were tested in simulations.
$40\unit{\mu m}$ is a good compromise between having a short enough bunch to stay within the accelerating region of the accelerating wakefield, $\approx \lambda_{pe}/4$ (see Section \ref{Int:BPI:BLoad}).




% ================================================================================================================================ %

\subsection{Studies with Single Drive Bunch}
\label{Sim:PBSingle}

Text

% ================================================================================================================================ %

\subsection{Simulation of the Plasma}
\label{Sim:Plasma}

Text

% ================================================================================================ %

\section{Beam Loading and Energy Spread}
\label{Sim:BLoad}

Text

% ================================================================================================ %

\section{Emittance Evolution}
\label{Sim:Emitt}

Emittance is preserved in the linear regime

% ================================================================================================ %
\subsection{The Quasi-Linear Regime}
\label{Sim:QLin}

Text

% ================================================================================================ %

\subsection{The Quasi-Linear + Non-Linear Case}
\label{Sim:QLinNonLin}

Quasi-linear reference \cite{rosenzweig:2010}.

An electron beam matched to the typical AWAKE plasma density will be, as discussed in \ref{Int:BPI:Match}, very narrow. At a typical normalised emittance of $2.0\unit{\mu m}$ the beam is $5.25\unit{\mu m}$. Even at low beam charge and at the upper limit in terms of beam length, the wakefields of such a beam will quickly reach the non-linear regime. In the base case used in the beam loading study included in Publication \ref{Pub:BL17} \cite{berglyd_olsen:2018} the peak density of the beam $n_b/n_0 > 35$, well beyond the saturation level of the bubble that occurs when $n_b/n_0 > 10$ \cite{lu:2005}.

The implication here is that there is an additional beneficial effect of loading the accelerating field with as much charge as it will allow without overloading it. The resulting non-linear wake driven by the head of the beam, which will see emittance growth due to the quasi-linear conditions of the proton wake, ensures that the rest of the beam sees a strong focusing force preventing further emittance growth. As the electron beam gains energy, its transverse size will decrease as its emittance is preserved as $\sigma_{r} = \sqrt{\emitN\beta}$ \cite{wille:2001}.

% ================================================================================================ %

\section{Optimising the Witness Beam}
\label{Sim:Opt}

Bringing it all together.

% ================================================================================================ %

% ================================================================================================ %
\section{Overview of Simulation Studies}
\label{Sim:Summary}

\begin{table}[hbt]
    \centering
    \caption{Overview of total simulation cost. $97\%$ of the simulations were run on the supercomputer \textit{Abel}, on Oct Core Intel Xeon E5-2670 CPUs. The remainder were run on older nodes with Quad Core AMD Opteron 2354 CPUs.}
    \label{T:SimCost}
    \begin{tabularx}{\textwidth}{Xlrrr}
        \rowcolor{tblhead}
        \texthh{Topic of Studies}                & \texthh{Code} & \texthh{Count} &     \texthh{CPU Time} &  \texthh{Average} \\
        \hline
        Preliminary studies (mostly testing)     & OSIRIS        &           $21$ &    $266\,599\unit{h}$ & $12\,695\unit{h}$ \\
        Full length AWAKE proton bunch studies   & OSIRIS        &           $38$ &    $440\,583\unit{h}$ & $11\,594\unit{h}$ \\
        Pre-modulated beam studies$^{1}$         & OSIRIS        &          $144$ &    $319\,093\unit{h}$ &  $2\,216\unit{h}$ \\
        3D reference studies                     & OSIRIS        &           $23$ &    $245\,974\unit{h}$ & $10\,695\unit{h}$ \\
        Single drive bunch studies$^{2}$         & OSIRIS        &          $124$ &     $47\,837\unit{h}$ &     $386\unit{h}$ \\
        Beam loading and emittance studies$^{3}$ & QuickPIC      &          $293$ &    $369\,887\unit{h}$ &  $1\,262\unit{h}$ \\
        \hline
        \rowcolor{tblfoot}
        Total                                    &               &          $657$ & $1\,479\,350\unit{h}$ &  $2\,252\unit{h}$ \\
        \multicolumn{5}{p{50mm}}{\footnotesize
            $^{1}$ Main studies for Publication \ref{Pub:IPAC15} \newline
            $^{2}$ Main studies for Publication \ref{Pub:NAPAC16} \newline
            $^{3}$ Main studies for Publication \ref{Pub:BL17} \newline
        }
    \end{tabularx}
\end{table}
